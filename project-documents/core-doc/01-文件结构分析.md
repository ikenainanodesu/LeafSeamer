# LeafSeamer 项目文件结构分析

## 1. 项目概述

LeafSeamer 是一个基于 NodeCG 的广播制作控制系统,采用模块化架构,每个功能独立为 NodeCG bundle。项目使用 Vite 构建工具进行现代化的前后端编译打包。

**项目版本**: 1.0.0  
**NodeCG版本**: ^2.6.4  
**构建工具**: Vite 6.0.1, TypeScript 5.7.2  
**分析时间**: 2025-12-17

---

## 2. 目录结构

### 2.1 根目录结构

```
LeafSeamer/
├── bundles/                      # NodeCG bundles 模块目录 (9个核心模块)
├── shared/                       # 共享资源
│   ├── types/                   # TypeScript 类型定义 (6个文件)
│   ├── utils/                   # 工具函数 (3个文件)
│   └── constants/               # 常量定义
├── scripts/                      # 构建脚本
├── cfg/                         # NodeCG 配置
├── db/                          # 数据库文件
├── logs/                        # 日志文件
├── backups/                     # 备份文件存储
├── project-documents/           # 项目文档
│   └── core-doc/               # 核心文档目录
├── assets/                      # 静态资源
├── node_modules/                # 依赖包
├── vite.config.dashboard.ts     # Vite Dashboard 配置
├── vite.config.extension.ts     # Vite Extension 配置
├── tsconfig.json                # TypeScript 配置
└── package.json                 # 项目配置
```

### 2.2 Bundle 标准结构

每个 bundle 遵循以下标准结构:

```
bundle-name/
├── extension/                   # 后端扩展代码 (Node.js)
│   ├── index.ts                # 入口文件
│   └── index.js                # 编译后的文件 (Vite生成)
├── src/                        # 前端源代码
│   ├── dashboard/              # Dashboard 面板源码
│   │   ├── *.html             # HTML 模板 (开发时)
│   │   └── *.tsx/.ts          # React/TypeScript 组件
│   └── graphics/               # Graphics 图形源码
│       ├── *.html             # HTML 模板
│       └── *.tsx/.ts          # React/TypeScript 组件
├── dashboard/                  # 编译后的 Dashboard (Vite输出)
│   ├── *.html                 # 带哈希的资源引用
│   └── *-[hash].js            # 打包后的 JS
├── graphics/                   # 编译后的 Graphics (Vite输出)
├── shared/                     # 编译时共享的 chunk
├── package.json               # Bundle 配置
└── tsconfig.json              # TypeScript 配置
```

---

## 3. 核心模块 (Bundles) 详细分析

### 3.1 seamer - 统一控制面板

**路径**: `bundles/seamer/`  
**功能**: 提供可视化的卡片式操作界面,整合其他 bundle 的控制功能

**主要组件**:

- `extension/index.ts` - 最小化的后端逻辑,主要用于日志
- `src/dashboard/App.tsx` - 主应用界面 (240行)
- `src/dashboard/components/Card.tsx` - 卡片组件
- `src/dashboard/components/EditCardModal.tsx` - 卡片编辑模态框
- `src/types/seamer.types.ts` - 类型定义

**核心功能**:

- 卡片式操作界面 (支持拖放 JSON 文件)
- 整合 mixer-control (调音台控制)
- 整合 vb-matrix-control (VB Matrix预设)
- 整合 obs-control (OBS 场景/转场控制)
- 支持多动作组合执行

**Dashboard 面板**: 1个 (Seamer Control, 宽度8)

### 3.2 mixer-control - 调音台控制

**路径**: `bundles/mixer-control/`  
**功能**: 通过 OSC 协议控制混音器

**主要组件**:

- `extension/index.ts` - 主入口,初始化管理器和消息监听
- `extension/connection.ts` - OSC 连接管理 (ConnectionManager)
- `extension/state-manager.ts` - 状态管理 (StateManager)
- `src/dashboard/mixer-connection.tsx` - 连接配置面板
- `src/dashboard/mixer-panel.tsx` - 主控制面板
- `src/dashboard/mixer-control-panel.tsx` - 输入通道控制
- `src/dashboard/output-control-panel.tsx` - 输出通道控制

**核心功能**:

- OSC 协议通信 (UDP/TCP)
- 推子控制 (Fader Level)
- 静音控制 (Mute)
- 输出路由查询和管理
- 实时状态更新

**Replicants**:

- `mixerConnectionSettings` - 连接配置
- `mixerState` - 混音器状态 (通道、输出、路由信息)

**Dashboard 面板**: 2个

- Mixer Connection (宽度4)
- Mixer Control (宽度8, workspace)

### 3.3 obs-control - OBS Studio 控制

**路径**: `bundles/obs-control/`  
**功能**: 通过 WebSocket 控制 OBS Studio

**主要组件**:

- `extension/index.ts` - 主入口
- `extension/connection.ts` - WebSocket 连接管理 (ConnectionManager)
- `extension/scene-manager.ts` - 场景管理 (SceneManager)
- `src/dashboard/obs-connection.tsx` - 连接配置面板
- `src/dashboard/obs-control-panel.tsx` - 控制面板

**核心功能**:

- 多 OBS 实例管理 (支持多个 OBS 连接)
- 场景切换
- 转场效果选择
- 推流/录制控制
- 实时状态监控 (流统计信息)
- 自动连接所有配置的 OBS 实例

**Replicants**:

- `obsConnections` - OBS 连接配置数组
- `obsStates` - 各 OBS 实例状态 (Record<string, OBSState>)

**Dashboard 面板**: 2个 (workspace: OBS Control)

- OBS Connection (宽度4)
- OBS Control (宽度4)

### 3.4 vb-matrix-control - VB-Audio Matrix 控制

**路径**: `bundles/vb-matrix-control/`  
**功能**: 通过 VBAN 协议控制 VB-Audio Matrix

**主要组件**:

- `extension/index.ts` - 入口
- `extension/manager.ts` - 核心管理器 (MatrixManager, 609行)
- `extension/vban.ts` - VBAN 协议发送器
- `src/dashboard/panel.tsx` - 主面板
- `src/dashboard/components/` - 多个 UI 组件
  - NetworkConfig.tsx - 网络配置
  - PatchSelector.tsx - 音频路由选择
  - PatchStatus.tsx - 补丁状态显示
  - PresetManager.tsx - 预设管理
  - Bank.tsx, BankSlot.tsx - 预设库
  - PresetDraggable.tsx - 拖拽功能

**核心功能**:

- VBAN 协议通信
- 音频路由矩阵管理
- Patch 控制 (输入/输出路由)
- 预设保存/加载 (持久化到文件)
- 网络配置和 Ping 测试
- 本地 IP 地址显示
- 拖拽式预设管理

**Replicants**:

- `networkConfig` - 网络配置
- `activePatches` - 当前激活的 patch
- `presets` - 预设列表
- `hostInfo` - 本地主机信息

**Dashboard 面板**: 1个 (VB Matrix Control, 宽度4)

### 3.5 graphics-package - 图形叠加包

**路径**: `bundles/graphics-package/`  
**功能**: 提供直播图形叠加 (Lower Third, Scoreboard)

**主要组件**:

- `extension/index.ts` - 数据 replicant 初始化
- `extension/data-fetcher.ts` - 数据获取逻辑
- `src/dashboard/graphics-control.tsx` - 控制面板
- `src/graphics/lower-third.tsx` - 字幕条图形
- `src/graphics/scoreboard.tsx` - 计分板图形

**核心功能**:

- GSAP 动画库集成
- Lower Third (字幕条) 显示
- Scoreboard (计分板) 显示
- 平滑的入场/出场动画

**Graphics 输出**: 2个 (1920x1080)

- lower-third.html
- scoreboard.html

**Dashboard 面板**: 1个 (Graphics Control, 宽度4)

### 3.6 schedule-manager - 日程管理

**路径**: `bundles/schedule-manager/`  
**功能**: 节目时间表管理和显示

**主要组件**:

- `extension/index.ts` - 后端入口
- `extension/schedule-loader.ts` - 日程加载器
- `src/dashboard/schedule-panel.tsx` - 控制面板
- `src/graphics/schedule-display.tsx` - 图形显示

**核心功能**:

- 节目时间表管理
- 日程图形输出
- Dashboard 控制

**Graphics 输出**: 1个
**Dashboard 面板**: 1个

### 3.7 logger-system - 日志系统

**路径**: `bundles/logger-system/`  
**功能**: 集中化日志收集和查看

**主要组件**:

- `extension/index.ts` - 入口,暴露 log API
- `extension/logger.ts` - 日志处理器
- `extension/storage.ts` - 日志存储
- `src/dashboard/log-viewer.tsx` - 日志查看器

**核心功能**:

- 集中化日志收集
- 实时日志查看器
- 异步日志处理
- 暴露 API 供其他 bundle 调用

**暴露的 API**:

```typescript
nodecg.extensions["logger-system"].log(level, category, message);
```

**Dashboard 面板**: 1个 (Log Viewer)

### 3.8 backup-system - 备份系统

**路径**: `bundles/backup-system/`  
**功能**: 自动备份项目配置和数据

**主要组件**:

- `extension/index.ts` - 入口
- `extension/backup-manager.ts` - 备份管理器 (97行)
- `src/dashboard/backup-control.tsx` - 控制面板

**核心功能**:

- 自动打包 cfg/ 和 db/ 目录
- 使用 archiver 创建 ZIP 压缩包
- 备份文件存储在 `backups/` 目录
- 备份列表管理和显示

**Replicants**:

- `backupList` - 备份文件列表

**Dashboard 面板**: 1个 (Backup Control)

### 3.9 data-sync-service - 数据同步服务

**路径**: `bundles/data-sync-service/`  
**功能**: Google APIs 集成,后台数据同步

**主要组件**:

- `extension/index.ts` - 后端入口
- `extension/google-sheets-client.ts` - Google Sheets 客户端

**核心功能**:

- Google APIs 集成
- 后台数据同步
- 无 Dashboard 界面

**Dashboard 面板**: 0个 (纯后端服务)

---

## 4. 共享资源 (Shared)

### 4.1 类型定义 (shared/types/)

1. **global.d.ts** - 全局类型声明
   - NodeCG 浏览器端类型
   - CSS 模块声明

2. **mixer.types.ts** - 调音台相关类型
   - MixerChannel - 通道信息
   - MixerOutput - 输出信息
   - MixerState - 状态
   - MixerConnectionSettings - 连接配置

3. **obs.types.ts** - OBS 相关类型
   - OBSScene - 场景信息
   - OBSConnectionStatus - 连接状态
   - OBSState - OBS 状态
   - StreamStats - 流统计
   - OBSConnectionSettings - 连接配置

4. **graphics.types.ts** - 图形相关类型

5. **animation.types.ts** - 动画相关类型

6. **common.types.ts** - 通用类型
   - LogLevel 等

### 4.2 工具函数 (shared/utils/)

1. **logger.ts** - 日志工具类 (62行)
   - Logger 类实现
   - 支持与 logger-system bundle 集成
   - 自动格式化日志消息

2. **gsap-animations.ts** - GSAP 动画工具

3. **timestamp.ts** - 时间戳工具

---

## 5. 构建系统

### 5.1 Vite 配置

**Dashboard 构建** (`vite.config.dashboard.ts`):

- 自动发现 `src/dashboard/**/*.html` 和 `src/graphics/**/*.html`
- 输出到 bundle 根目录的 `dashboard/` 和 `graphics/`
- React 插件集成
- 资源哈希化命名
- 共享 chunk 输出到 `shared/` 目录

**Extension 构建** (`vite.config.extension.ts`):

- 编译 `extension/index.ts` 为 CommonJS 格式
- external 配置排除 Node.js 模块和第三方依赖
- 输出到 `extension/index.js`
- 不压缩,保留可读性

### 5.2 构建流程

通过环境变量 `BUNDLE_NAME` 指定要构建的 bundle:

```bash
# 构建单个 bundle
cd bundles/[bundle-name]
npm run build:extension  # 构建后端
npm run build:dashboard  # 构建前端
npm run build           # 构建全部

# 监听模式
npm run watch:extension
```

---

## 6. NodeCG 启动流程分析

### 6.1 Extension 加载顺序

NodeCG 启动时,会按以下顺序加载各 bundle 的 extension:

1. **logger-system** - 首先启动,提供日志服务
2. **其他 bundles** - 可以使用 logger-system 的 API

### 6.2 Replicants 通信机制

各 bundle 通过 NodeCG Replicants 共享状态:

**跨 Bundle 访问示例** (seamer 访问其他 bundle):

```typescript
// 访问 mixer-control 的状态
const mixerRep = nodecg.Replicant<MixerState>("mixerState", "mixer-control");

// 访问 vb-matrix-control 的预设
const presetsRep = nodecg.Replicant<Preset[]>("presets", "vb-matrix-control");

// 访问 obs-control 的状态
const obsStateRep = nodecg.Replicant<Record<string, OBSState>>(
  "obsStates",
  "obs-control"
);
```

### 6.3 消息通信机制

Bundles 通过 NodeCG 消息系统进行跨 bundle 调用:

**seamer 调用其他 bundle 示例**:

```typescript
// 调用 mixer-control
nodecg.sendMessageToBundle("setMixerFader", "mixer-control", {
  channelId: action.channelId,
  level: action.level,
});

// 调用 vb-matrix-control
nodecg.sendMessageToBundle("loadPreset", "vb-matrix-control", action.presetId);

// 调用 obs-control
nodecg.sendMessageToBundle("setOBSScene", "obs-control", {
  id: action.connectionId,
  scene: action.sceneName,
});
```

---

## 7. Dashboard 面板汇总

| Bundle            | 面板名称          | 宽度 | Workspace     |
| ----------------- | ----------------- | ---- | ------------- |
| seamer            | Seamer Control    | 8    | Seamer        |
| mixer-control     | Mixer Connection  | 4    | -             |
| mixer-control     | Mixer Control     | 8    | Mixer Control |
| obs-control       | OBS Connection    | 4    | OBS Control   |
| obs-control       | OBS Control       | 4    | OBS Control   |
| vb-matrix-control | VB Matrix Control | 4    | -             |
| graphics-package  | Graphics Control  | 4    | -             |
| schedule-manager  | Schedule Panel    | -    | -             |
| logger-system     | Log Viewer        | -    | -             |
| backup-system     | Backup Control    | -    | -             |

**总计**: 10个 Dashboard 面板,分布在 3个 Workspace

---

## 8. 文件统计

### 8.1 代码文件统计

- **TypeScript 文件 (.ts)**: 23个
- **TSX 文件 (.tsx)**: 26个
- **HTML 文件**: 28个 (包含源文件和编译后文件)
- **Package.json**: 16个 (含 .off 文件)

### 8.2 核心代码行数 (主要文件)

| 文件                                      | 行数 | 功能                 |
| ----------------------------------------- | ---- | -------------------- |
| vb-matrix-control/extension/manager.ts    | 609  | VB Matrix 核心管理器 |
| seamer/src/dashboard/App.tsx              | 240  | Seamer 主界面        |
| backup-system/extension/backup-manager.ts | 97   | 备份管理器           |
| mixer-control/extension/index.ts          | 68   | Mixer 入口           |
| shared/utils/logger.ts                    | 62   | 日志工具             |

---

## 9. 依赖分析

### 9.1 核心依赖

**生产依赖**:

- `nodecg`: ^2.6.4 - 核心框架
- `react`: ^19.2.1 - UI 框架
- `react-dom`: ^19.2.1
- `gsap`: ^3.13.0 - 动画库
- `node-osc`: ^11.1.1 - OSC 协议

**开发依赖**:

- `vite`: ^6.0.1 - 构建工具
- `typescript`: ^5.7.2 - 类型系统
- `esbuild`: ^0.27.1 - 打包器
- `obs-websocket-js`: ^5.0.7 - OBS WebSocket 客户端
- `archiver`: ^7.0.1 - 文件归档
- `googleapis`: ^166.0.0 - Google API

### 9.2 Bundle 特定依赖

- **seamer**: uuid
- **mixer-control**: node-osc
- **obs-control**: obs-websocket-js, uuid
- **vb-matrix-control**: @dnd-kit/core (拖拽功能)
- **graphics-package**: @gsap/react, gsap
- **backup-system**: archiver, async
- **data-sync-service**: googleapis

---

## 10. 总结

LeafSeamer 是一个设计良好的模块化广播控制系统:

**优点**:

1. ✅ 清晰的模块化架构,每个功能独立为 bundle
2. ✅ 使用现代化构建工具 (Vite)
3. ✅ TypeScript 类型安全
4. ✅ 共享代码合理组织 (shared/)
5. ✅ 支持多设备/多实例控制 (OBS 多连接)
6. ✅ 统一的日志系统
7. ✅ 完善的备份机制

**架构特点**:

- 前后端分离 (extension vs dashboard/graphics)
- 响应式状态管理 (Replicants)
- 消息驱动通信 (NodeCG Messages)
- 可扩展性强 (易于添加新 bundle)

**主要应用场景**:

- 视频直播制作
- 广播节目制作
- 多设备集中控制
- 实时图形叠加

该项目结构合理,代码组织清晰,是一个成熟的广播制作控制系统。
