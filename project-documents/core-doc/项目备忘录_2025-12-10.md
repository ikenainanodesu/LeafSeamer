# LeafSeamer 项目备忘录

**生成日期**: 2025-12-10  
**项目版本**: 1.0.0

## 项目概况

LeafSeamer 是一个基于 NodeCG 2.x 框架的广播制作控制系统,采用模块化架构设计,整合了多种专业设备和服务的控制能力。项目使用 TypeScript + React + Vite 技术栈,为广播和视频制作提供统一的 Web 控制平台。

## 技术架构

### 框架和构建

- **基础框架**: NodeCG 2.6.4
- **前端框架**: React 19.2.1
- **开发语言**: TypeScript 5.7.2
- **构建工具**: Vite 6.0.1 (双配置: dashboard + extension)
- **包管理**: npm workspaces (monorepo 结构)

### 架构特点

1. **前后端分离**: Extension (Node.js后端) 和 Dashboard (React前端) 独立构建
2. **TypeScript 统一**: 所有代码使用 TypeScript 编写,类型定义集中在 `shared/types`
3. **Vite 打包**: 使用 Vite 构建,支持热更新和快速开发
4. **模块化设计**: 8个独立 bundle,可按需启用和部署

## 各模块详细状态

### 1. mixer-control (调音台控制)

**功能**: 通过 OSC 协议控制专业调音台(如 Yamaha DM3)

**技术栈**:

- node-osc v11.0.0 - OSC 协议通信
- React Dashboard - 连接管理和状态显示

**主要功能**:

- OSC 连接管理(IP地址、端口配置)
- 输入通道状态监控
- 路由信息查询(Input Sends, Input Patch, Output Patch)
- 实时音量和静音状态显示

**Dashboard 面板**:

- Mixer Connection (宽度4) - 连接管理
- Mixer Control (宽度8) - 主控制面板

**状态**: 运行正常,初始状态已修复为 disconnected

### 2. obs-control (OBS 控制)

**功能**: 通过 WebSocket 控制 OBS Studio

**技术栈**:

- obs-websocket-js v5.0.0 - OBS WebSocket 客户端

**主要功能**:

- OBS 连接管理
- 场景切换控制
- 录制和推流控制
- 实时状态监控

**Dashboard 面板**:

- OBS Connection (宽度4) - 连接管理
- OBS Control (宽度4) - 控制面板

**状态**: 功能正常,已解决 OBSWebSocket 构造函数问题

### 3. graphics-package (图形叠加包)

**功能**: 提供广播图形叠加,支持 GSAP 动画

**技术栈**:

- GSAP v3.13.0 - 动画引擎
- @gsap/react v2.1.2 - React 集成

**Graphics 输出**:

- lower-third.html (1920x1080) - 字幕条
- scoreboard.html (1920x1080) - 计分板

**动画特性**:

- 自定义 GSAP 动画库
- 滑入/淡入效果
- 时序控制(line2 延迟 0.5s)
- 反向退出动画

**Dashboard 面板**:

- Graphics Control (宽度4) - 图形控制

**状态**: GSAP 集成已完成,动画库已优化

### 4. vb-matrix-control (VB-Audio Matrix 控制)

**功能**: 通过 VBAN 协议控制 VB-Audio Matrix 音频路由

**主要功能**:

- VBAN 网络配置
- 音频路由矩阵管理
- Ping 测试(5次,1秒间隔,成功/失败视觉反馈)
- 本地 IP 地址显示
- Patch 状态显示(根据设备选择状态动态显示)

**Dashboard 面板**:

- VB Matrix Control (宽度4) - 控制面板

**状态**: UI 已优化,网络配置功能完善

### 5. logger-system (日志系统)

**功能**: 集中化日志收集和查看

**技术栈**:

- async v3.2.5 - 异步处理

**主要功能**:

- 日志收集
- 实时日志查看
- 日志过滤和搜索

**Dashboard 面板**:

- Log Viewer (宽度6) - 日志查看器

**状态**: 基础功能正常,曾出现显示问题已修复

### 6. backup-system (备份系统)

**功能**: 项目配置和数据备份

**技术栈**:

- archiver v7.0.1 - 文件归档

**主要功能**:

- 自动备份配置
- 手动备份触发
- 备份文件管理

**Dashboard 面板**:

- Backup Control (宽度4) - 备份控制

**状态**: 功能正常

### 7. schedule-manager (日程管理)

**功能**: 节目日程管理和显示

**Graphics 输出**:

- schedule-display.html (1920x1080) - 日程显示

**Dashboard 面板**:

- Schedule Manager (宽度4) - 日程管理

**状态**: 功能正常

### 8. data-sync-service (数据同步服务)

**功能**: 后台数据同步服务

**技术栈**:

- googleapis v144.0.0 - Google API 客户端

**特点**:

- 无 Dashboard 界面(纯后台服务)
- Google Sheets 等数据同步

**状态**: 后台运行

## 共享资源

### shared/types (类型定义)

- `animation.types.ts` - 动画相关类型
- `common.types.ts` - 通用类型
- `global.d.ts` - 全局类型声明
- `graphics.types.ts` - 图形相关类型
- `mixer.types.ts` - 调音台相关类型
- `obs.types.ts` - OBS 相关类型

### shared/utils (工具函数)

提供各模块共享的工具函数

### shared/constants (常量定义)

项目级别的常量定义

## 构建系统

### Vite 双配置

1. **vite.config.dashboard.ts**:
   - 构建 React Dashboard 组件
   - 输出到各 bundle 的 `dashboard` 目录

2. **vite.config.extension.ts**:
   - 构建 Node.js Extension
   - 输出到各 bundle 的 `extension` 目录

### Build Scripts

- `npm run build` - 执行 `scripts/build-bundles.ts`
- 每个 bundle 独立构建
- 支持 watch 模式

## 已知问题和改进计划

### 已解决问题

- ✅ Mixer control 初始状态错误(已修复为 disconnected)
- ✅ OBS control 构造函数问题(已修复)
- ✅ Dashboard 显示消失问题(HTML script 引用修复)
- ✅ Logger system 显示问题(已修复)
- ✅ Lower third 动画效果(已优化)
- ✅ VB Matrix Control UI 优化(Ping测试、IP显示、条件显示)

### 架构改进方向

1. **前后端分离优化**:
   - 当前 Extension 和 Dashboard 分离良好
   - 可考虑进一步优化构建流程

2. **冗余文件清理**:
   - 检查重复的编译产物
   - 优化构建输出目录

3. **类型系统增强**:
   - 完善 shared types
   - 增加类型覆盖率

4. **测试覆盖**:
   - 当前缺少自动化测试
   - 建议添加单元测试和集成测试

5. **文档完善**:
   - 各 bundle 添加详细 README
   - API 文档生成

## 项目文档位置

### 现有文档

- `project-documents/GSAP集成可行性分析.md` - GSAP 集成研究
- `project-documents/GSAP集成完成报告.md` - GSAP 完成报告
- `project-documents/VBAN-command.md` - VBAN 指令文档
- `project-documents/VBAN_TEXT指令指南.md` - VBAN TEXT 指令
- `project-documents/DM3_osc_specs_v100_en.pdf` - DM3 OSC 规格
- `project-documents/needs.md` - 需求文档
- `project-documents/todo-list.md` - 待办事项
- `project-documents/prompt.md` - 提示文档

### 核心文档目录

`project-documents/core-doc/` - 用于存放项目核心文档和备忘录

## 运行环境

- **Node.js**: 需要 Node.js 环境
- **端口**: 默认 9090
- **监听地址**: 可配置为 0.0.0.0 (cfg 配置)

## 部署说明

### 本地开发

```bash
npm install
npm start
```

### 生产构建

```bash
npm run build
npm start
```

## 关键依赖版本

| 依赖             | 版本    | 用途       |
| ---------------- | ------- | ---------- |
| nodecg           | 2.6.4   | 核心框架   |
| react            | 19.2.1  | UI框架     |
| typescript       | 5.7.2   | 开发语言   |
| vite             | 6.0.1   | 构建工具   |
| gsap             | 3.13.0  | 动画库     |
| obs-websocket-js | 5.0.7   | OBS控制    |
| node-osc         | 11.1.1  | OSC协议    |
| googleapis       | 166.0.0 | Google API |

## 开发团队备注

- 所有技术栈使用前需查阅官方文档
- 遵循 KISS 原则,保持代码简洁
- 使用第一性原理分析问题
- 充分调研后再实施方案

---

**备注**: 本备忘录基于项目当前状态自动生成,如有更新请及时修订。
