# LeafSeamer ç³»ç»Ÿæµç¨‹å›¾

> åˆ›å»ºæ—¶é—´: 2025-12-04  
> æœ€åæ›´æ–°: 2025-12-04  
> ç‰ˆæœ¬: v1.0

æœ¬æ–‡æ¡£åŒ…å« LeafSeamer ç³»ç»Ÿçš„å„ç±»æµç¨‹å›¾ï¼Œå¸®åŠ©ç†è§£ç³»ç»Ÿè¿ä½œæœºåˆ¶ã€‚

---

## ğŸ“Š ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ€»è§ˆ](#ç³»ç»Ÿæ¶æ„æ€»è§ˆ)
2. [å¯åŠ¨æµç¨‹](#å¯åŠ¨æµç¨‹)
3. [Mixer Control å·¥ä½œæµ](#mixer-control-å·¥ä½œæµ)
4. [OBS Control å·¥ä½œæµ](#obs-control-å·¥ä½œæµ)
5. [æ•°æ®åŒæ­¥æµç¨‹](#æ•°æ®åŒæ­¥æµç¨‹)
6. [æ—¥å¿—ç³»ç»Ÿæµç¨‹](#æ—¥å¿—ç³»ç»Ÿæµç¨‹)
7. [å¤‡ä»½æ¢å¤æµç¨‹](#å¤‡ä»½æ¢å¤æµç¨‹)

---

## ç³»ç»Ÿæ¶æ„æ€»è§ˆ

```mermaid
graph TB
    subgraph Cloud["â˜ï¸ äº‘ç«¯å±‚ (Google Cloud)"]
        GS[Google Sheets<br/>å†·æ•°æ®å­˜å‚¨]
        GAS[Google Apps Script<br/>è¡¨æ ¼é€»è¾‘å¤„ç†]
    end

    subgraph Local["ğŸ’» æœ¬åœ°å±‚ (NodeCG)"]
        NC[NodeCG æ ¸å¿ƒ]

        subgraph Bundles["Bundle æ¨¡å—"]
            MC[Mixer Control<br/>è°ƒéŸ³å°æ§åˆ¶]
            OC[OBS Control<br/>OBSæ§åˆ¶]
            GP[Graphics Package<br/>å›¾æ–‡åŒ…è£…]
            SM[Schedule Manager<br/>æ’­æ§åˆ—è¡¨]
        end

        subgraph Core["æ ¸å¿ƒæœåŠ¡"]
            LOG[æ—¥å¿—ç³»ç»Ÿ]
            BKP[å¤‡ä»½/æ¢å¤ç³»ç»Ÿ]
            SYNC[æ•°æ®åŒæ­¥æœåŠ¡]
        end
    end

    subgraph External["ğŸ”Œ å¤–éƒ¨è®¾å¤‡"]
        MIXER[Yamaha DM3<br/>è°ƒéŸ³å°]
        OBS[OBS Studio<br/>v32.0]
    end

    GS -->|æ‹‰å–é…ç½®| SYNC
    SYNC -->|ä¸Šè¡ŒåŒæ­¥| GAS
    NC --> Bundles
    NC --> Core
    MC <-->|OSC| MIXER
    OC <-->|WebSocket| OBS
    SYNC --> MC
    SYNC --> GP
    LOG -.ç›‘å¬.-> Bundles
    BKP -.å¤‡ä»½.-> Bundles
    BKP -.å¤‡ä»½.-> Core
```

---

## å¯åŠ¨æµç¨‹

```mermaid
flowchart TD
    Start([ç³»ç»Ÿå¯åŠ¨]) --> InitNodeCG[åˆå§‹åŒ– NodeCG æ ¸å¿ƒ]
    InitNodeCG --> LoadConfig[åŠ è½½é…ç½®æ–‡ä»¶<br/>cfg/leafseamer.json]
    LoadConfig --> LoadBundles[æ‰«æå¹¶åŠ è½½æ‰€æœ‰ Bundles]

    LoadBundles --> InitSync[å¯åŠ¨æ•°æ®åŒæ­¥æœåŠ¡]
    InitSync --> FetchCloud{ä» Google Sheets<br/>æ‹‰å–é…ç½®}
    FetchCloud -->|æˆåŠŸ| CacheData[ç¼“å­˜é…ç½®åˆ°æœ¬åœ°<br/>db/ ç›®å½•]
    FetchCloud -->|å¤±è´¥| UseCached[ä½¿ç”¨æœ¬åœ°ç¼“å­˜é…ç½®]

    CacheData --> InitModules{åˆå§‹åŒ–å„æ¨¡å—}
    UseCached --> InitModules

    InitModules --> MixerInit[Mixer Control åˆå§‹åŒ–]
    InitModules --> OBSInit[OBS Control åˆå§‹åŒ–]
    InitModules --> GraphicsInit[Graphics Package åˆå§‹åŒ–]
    InitModules --> ScheduleInit[Schedule Manager åˆå§‹åŒ–]
    InitModules --> LoggerInit[Logger System å¯åŠ¨]
    InitModules --> BackupInit[Backup System å¯åŠ¨]

    MixerInit --> MixerConnect{å°è¯•è¿æ¥è°ƒéŸ³å°}
    MixerConnect -->|æˆåŠŸ| MixerReady[Mixer Control å°±ç»ª]
    MixerConnect -->|å¤±è´¥| MixerRetry[å®šæ—¶é‡è¯•è¿æ¥]
    MixerRetry -.æ¯ 5 ç§’.-> MixerConnect

    OBSInit --> OBSConnect{å°è¯•è¿æ¥ OBS}
    OBSConnect -->|æˆåŠŸ| OBSReady[OBS Control å°±ç»ª]
    OBSConnect -->|å¤±è´¥| OBSRetry[å®šæ—¶é‡è¯•è¿æ¥]
    OBSRetry -.æ¯ 5 ç§’.-> OBSConnect

    GraphicsInit --> GraphicsReady[Graphics Package å°±ç»ª]
    ScheduleInit --> ScheduleReady[Schedule Manager å°±ç»ª]
    LoggerInit --> LoggerReady[Logger System å°±ç»ª]
    BackupInit --> BackupReady[Backup System å°±ç»ª]

    MixerReady --> AllReady{æ‰€æœ‰æ ¸å¿ƒæ¨¡å—å°±ç»ª?}
    OBSReady --> AllReady
    GraphicsReady --> AllReady
    LoggerReady --> AllReady
    BackupReady --> AllReady

    AllReady -->|æ˜¯| OpenDashboard[æ‰“å¼€ Dashboard<br/>http://localhost:9090]
    AllReady -->|å¦| WaitModules[ç­‰å¾…å…¶ä»–æ¨¡å—]

    OpenDashboard --> SystemRunning([ç³»ç»Ÿè¿è¡Œä¸­])

    SystemRunning --> MonitorHealth[å¥åº·ç›‘æ§]
    MonitorHealth -.å®šæœŸæ£€æŸ¥.-> CheckConnections{æ£€æŸ¥è¿æ¥çŠ¶æ€}
    CheckConnections -->|å¼‚å¸¸| TriggerReconnect[è§¦å‘é‡è¿]
    CheckConnections -->|æ­£å¸¸| MonitorHealth
    TriggerReconnect --> MixerConnect
    TriggerReconnect --> OBSConnect
```

---

## Mixer Control å·¥ä½œæµ

### è¿æ¥ä¸çŠ¶æ€ç›‘å¬

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ· Dashboard
    participant Ext as Mixer Extension
    participant OSC as OSC Client
    participant Mixer as Yamaha DM3
    participant Rep as Replicant
    participant Log as Logger

    User->>Ext: ç‚¹å‡» "è¿æ¥è°ƒéŸ³å°" æŒ‰é’®
    activate Ext
    Ext->>Ext: è¯»å–è¿æ¥é…ç½®<br/>(IP, Port)
    Ext->>OSC: åˆ›å»º OSC Client & Server
    activate OSC

    OSC->>Mixer: å‘é€æµ‹è¯•è¿æ¥æ¶ˆæ¯
    activate Mixer
    Mixer-->>OSC: è¿”å›è¿æ¥ç¡®è®¤
    OSC-->>Ext: è§¦å‘ connected äº‹ä»¶
    deactivate OSC

    Ext->>Rep: æ›´æ–° Replicant<br/>connected = true<br/>timestamp = now()
    activate Rep
    Rep-->>User: è‡ªåŠ¨åŒæ­¥åˆ° Dashboard<br/>æ˜¾ç¤º"å·²è¿æ¥"çŠ¶æ€
    deactivate Rep

    Ext->>Log: è®°å½•æ—¥å¿—<br/>event: "mixer_connected"<br/>timestamp: now()
    activate Log
    Log->>Log: å¼‚æ­¥å†™å…¥æ—¥å¿—æ–‡ä»¶
    deactivate Log

    Ext->>Mixer: è¯·æ±‚å®Œæ•´çŠ¶æ€<br/>(channels, faders, DCAç­‰)
    Mixer-->>Ext: è¿”å›å½“å‰çŠ¶æ€æ•°æ®
    Ext->>Rep: æ›´æ–°å®Œæ•´ MixerState<br/>timestamp = now()
    Rep-->>User: åŒæ­¥æ˜¾ç¤ºæ‰€æœ‰çŠ¶æ€
    deactivate Ext

    loop å®æ—¶ç›‘å¬ OSC æ¶ˆæ¯
        Mixer->>Ext: å‘é€çŠ¶æ€å˜åŒ–<br/>(fader ç§»åŠ¨, channel on/off ç­‰)
        activate Ext
        Ext->>Ext: è§£æ OSC åœ°å€å’Œå‚æ•°<br/>ä¾‹: /ch/01/mix/fader 0.5
        Ext->>Rep: æ›´æ–°å¯¹åº” Replicant å€¼<br/>timestamp = now()
        Rep-->>User: å®æ—¶åˆ·æ–° Dashboard æ˜¾ç¤º
        Ext->>Log: è®°å½•çŠ¶æ€å˜åŒ–æ—¥å¿—
        deactivate Ext
    end
```

### ç”¨æˆ·æ“ä½œä¸ä¸Šè¡ŒåŒæ­¥

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ· Dashboard
    participant Ext as Mixer Extension
    participant OSC as OSC Client
    participant Mixer as Yamaha DM3
    participant Rep as Replicant
    participant SYNC as Data Sync Service
    participant Cloud as Google Sheets
    participant Log as Logger

    rect rgb(200, 230, 255)
    note right of User: åœºæ™¯ 1: ç”¨æˆ·è°ƒæ•´ Fader
    User->>Ext: æ‹–åŠ¨ Channel 1 Fader åˆ° -10dB
    activate Ext
    Ext->>OSC: æ„é€  OSC å‘½ä»¤<br/>/ch/01/mix/fader <value>
    OSC->>Mixer: å‘é€ OSC å‘½ä»¤
    activate Mixer
    Mixer->>Mixer: æ‰§è¡Œ Fader å˜åŒ–
    Mixer-->>OSC: å‘é€ç¡®è®¤/çŠ¶æ€æ›´æ–°
    deactivate Mixer
    OSC-->>Ext: è§¦å‘çŠ¶æ€å˜åŒ–äº‹ä»¶
    Ext->>Rep: æ›´æ–° Replicant<br/>channels[0].fader = -10<br/>timestamp = now()
    Rep-->>User: åŒæ­¥æ˜¾ç¤ºæ–°å€¼
    Ext->>Log: è®°å½•æ“ä½œæ—¥å¿—<br/>event: "fader_changed"
    deactivate Ext
    end

    rect rgb(255, 240, 200)
    note right of User: åœºæ™¯ 2: æ£€æµ‹å¹½çµé€šé“
    User->>Ext: ç‚¹å‡» "æ£€æµ‹å¹½çµé€šé“" æŒ‰é’®
    activate Ext
    Ext->>Rep: è¯»å–å½“å‰ channels æ•°æ®
    Rep-->>Ext: è¿”å› channels æ•°ç»„
    Ext->>Ext: è¿‡æ»¤æ¡ä»¶:<br/>fader === -Infinity && on === true
    Ext->>Rep: æ›´æ–° ghostChannels Replicant<br/>timestamp = now()
    Rep-->>User: æ˜¾ç¤ºå¹½çµé€šé“åˆ—è¡¨
    Ext->>Log: è®°å½•æ£€æµ‹ç»“æœæ—¥å¿—
    deactivate Ext
    end

    rect rgb(200, 255, 200)
    note right of User: åœºæ™¯ 3: ä¸Šè¡ŒåŒæ­¥åˆ°äº‘ç«¯
    User->>Ext: ç‚¹å‡» "åŒæ­¥é…ç½®åˆ°äº‘ç«¯" æŒ‰é’®
    activate Ext
    Ext->>Rep: è¯»å–å®Œæ•´ MixerState
    Rep-->>Ext: è¿”å›å½“å‰çŠ¶æ€ JSON
    Ext->>SYNC: è°ƒç”¨ syncToCloud(mixerState)
    activate SYNC
    SYNC->>SYNC: æ ¼å¼åŒ–ä¸º Sheets æ•°æ®æ ¼å¼
    SYNC->>Cloud: è°ƒç”¨ Google Sheets API<br/>æ›´æ–°è¡¨1æ•°æ®
    activate Cloud
    Cloud-->>SYNC: è¿”å›æ›´æ–°æˆåŠŸ
    deactivate Cloud
    SYNC-->>Ext: åŒæ­¥å®Œæˆ
    deactivate SYNC
    Ext->>Log: è®°å½•åŒæ­¥æ—¥å¿—<br/>event: "cloud_sync_success"<br/>timestamp: now()
    Ext->>User: æ˜¾ç¤ºæç¤º "åŒæ­¥æˆåŠŸ"
    deactivate Ext
    end
```

### å¹½çµé€šé“æ£€æµ‹ç®—æ³•

```mermaid
flowchart TD
    Start([å¼€å§‹æ£€æµ‹å¹½çµé€šé“]) --> GetChannels[è·å–æ‰€æœ‰ Channel æ•°æ®]
    GetChannels --> InitGhostList[åˆå§‹åŒ–ç©ºå¹½çµé€šé“åˆ—è¡¨]

    InitGhostList --> LoopChannels{éå†æ‰€æœ‰ Channel}
    LoopChannels -->|æœ‰ä¸‹ä¸€ä¸ª| CheckFader{Fader å€¼ = -âˆ ?}
    LoopChannels -->|æ— | ReturnResult[è¿”å›å¹½çµé€šé“åˆ—è¡¨]

    CheckFader -->|å¦| LoopChannels
    CheckFader -->|æ˜¯| CheckOn{Channel On = true ?}

    CheckOn -->|å¦| LoopChannels
    CheckOn -->|æ˜¯| AddToGhost[æ·»åŠ åˆ°å¹½çµé€šé“åˆ—è¡¨]
    AddToGhost --> LoopChannels

    ReturnResult --> UpdateReplicant[æ›´æ–° ghostChannels Replicant<br/>timestamp = now()]
    UpdateReplicant --> LogResult[è®°å½•æ—¥å¿—:<br/>æ‰¾åˆ° N ä¸ªå¹½çµé€šé“]
    LogResult --> End([æ£€æµ‹å®Œæˆ])
```

---

## OBS Control å·¥ä½œæµ

### è¿æ¥ä¸åœºæ™¯ç®¡ç†

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ· Dashboard
    participant Ext as OBS Extension
    participant WS as WebSocket Client
    participant OBS as OBS Studio
    participant Rep as Replicant
    participant Log as Logger

    User->>Ext: ç‚¹å‡» "è¿æ¥ OBS" æŒ‰é’®
    activate Ext
    Ext->>Ext: è¯»å–è¿æ¥é…ç½®<br/>(host, port, password)
    Ext->>WS: å»ºç«‹ WebSocket è¿æ¥<br/>ws://localhost:4455
    activate WS

    WS->>OBS: å‘é€ Hello æ¶ˆæ¯
    activate OBS
    OBS-->>WS: è¿”å› Hello + é‰´æƒä¿¡æ¯
    WS->>WS: è®¡ç®—é‰´æƒ Hash
    WS->>OBS: å‘é€ Identify æ¶ˆæ¯ (é‰´æƒ)
    OBS-->>WS: è¿”å› Identified (è¿æ¥æˆåŠŸ)
    WS-->>Ext: è§¦å‘ connected äº‹ä»¶
    deactivate WS

    Ext->>Rep: æ›´æ–° Replicant<br/>connected = true<br/>timestamp = now()
    activate Rep
    Rep-->>User: æ˜¾ç¤º "å·²è¿æ¥ OBS"
    deactivate Rep

    Ext->>Log: è®°å½•è¿æ¥æ—¥å¿—<br/>event: "obs_connected"
    activate Log
    Log->>Log: å¼‚æ­¥å†™å…¥æ—¥å¿—
    deactivate Log

    Ext->>OBS: è¯·æ±‚å½“å‰çŠ¶æ€<br/>GetSceneList, GetCurrentScene, GetStreamStatus
    OBS-->>Ext: è¿”å›å½“å‰åœºæ™¯å’Œæ¨æµçŠ¶æ€
    Ext->>Rep: æ›´æ–° OBSState Replicant<br/>timestamp = now()
    Rep-->>User: æ˜¾ç¤ºåœºæ™¯åˆ—è¡¨å’Œæ¨æµçŠ¶æ€
    deactivate Ext
    deactivate OBS

    loop å®æ—¶ç›‘å¬ WebSocket äº‹ä»¶
        OBS->>Ext: å‘é€äº‹ä»¶<br/>(CurrentSceneChanged, StreamStateChangedç­‰)
        activate Ext
        Ext->>Ext: è§£æäº‹ä»¶ç±»å‹å’Œæ•°æ®
        Ext->>Rep: æ›´æ–°å¯¹åº” Replicant<br/>timestamp = now()
        Rep-->>User: å®æ—¶æ›´æ–° Dashboard
        Ext->>Log: è®°å½•äº‹ä»¶æ—¥å¿—
        deactivate Ext
    end
```

### è§†é¢‘é˜Ÿåˆ—ç®¡ç†æµç¨‹

```mermaid
flowchart TD
    Start([ç”¨æˆ·æ‰“å¼€è§†é¢‘é˜Ÿåˆ—ç®¡ç†]) --> ShowQueue[æ˜¾ç¤ºå½“å‰é˜Ÿåˆ—åˆ—è¡¨]
    ShowQueue --> UserAction{ç”¨æˆ·æ“ä½œ}

    UserAction -->|æ·»åŠ è§†é¢‘| BrowseFile[æµè§ˆæœ¬åœ°æ–‡ä»¶]
    BrowseFile --> SelectVideo{é€‰æ‹©è§†é¢‘æ–‡ä»¶}
    SelectVideo -->|å–æ¶ˆ| ShowQueue
    SelectVideo -->|ç¡®è®¤| ValidateFile{éªŒè¯æ–‡ä»¶æ ¼å¼}

    ValidateFile -->|ä¸æ”¯æŒ| ShowError[æ˜¾ç¤ºé”™è¯¯æç¤º<br/>"ä¸æ”¯æŒçš„æ ¼å¼"]
    ShowError --> ShowQueue
    ValidateFile -->|æ”¯æŒ| AddToQueue[æ·»åŠ åˆ° videoQueue æ•°ç»„]

    AddToQueue --> UpdateRep1[æ›´æ–° videoQueue Replicant<br/>timestamp = now()]
    UpdateRep1 --> LogAdd[è®°å½•æ—¥å¿—: video_added]
    LogAdd --> ShowQueue

    UserAction -->|æ’­æ”¾é¦–ä¸ªè§†é¢‘| CheckQueue{é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º?}
    CheckQueue -->|æ˜¯| ShowEmpty[æ˜¾ç¤º "é˜Ÿåˆ—ä¸ºç©º" æç¤º]
    ShowEmpty --> ShowQueue
    CheckQueue -->|å¦| GetFirst[è·å–é˜Ÿåˆ—é¦–é¡¹è§†é¢‘]

    GetFirst --> SendToOBS[é€šè¿‡ WebSocket å‘é€<br/>SetSourceSettings å‘½ä»¤]
    SendToOBS --> OBSPlay{OBS æ’­æ”¾æˆåŠŸ?}

    OBSPlay -->|å¤±è´¥| ShowPlayError[æ˜¾ç¤ºæ’­æ”¾å¤±è´¥æç¤º]
    ShowPlayError --> ShowQueue
    OBSPlay -->|æˆåŠŸ| RemoveFromQueue[ä»é˜Ÿåˆ—ç§»é™¤é¦–é¡¹]

    RemoveFromQueue --> UpdateRep2[æ›´æ–° videoQueue Replicant<br/>timestamp = now()]
    UpdateRep2 --> LogPlay[è®°å½•æ—¥å¿—: video_played]
    LogPlay --> ShowQueue

    UserAction -->|åˆ é™¤è§†é¢‘| SelectDelete{é€‰æ‹©è¦åˆ é™¤çš„è§†é¢‘}
    SelectDelete --> ConfirmDelete{ç¡®è®¤åˆ é™¤?}
    ConfirmDelete -->|å–æ¶ˆ| ShowQueue
    ConfirmDelete -->|ç¡®è®¤| RemoveItem[ä»é˜Ÿåˆ—ç§»é™¤è¯¥é¡¹]

    RemoveItem --> UpdateRep3[æ›´æ–° videoQueue Replicant<br/>timestamp = now()]
    UpdateRep3 --> LogDelete[è®°å½•æ—¥å¿—: video_removed]
    LogDelete --> ShowQueue
```

### æ¨æµç›‘æ§æµç¨‹

```mermaid
sequenceDiagram
    participant OBS as OBS Studio
    participant Ext as OBS Extension
    participant Rep as Replicant
    participant Dashboard as Dashboard
    participant Graphics as ç›‘æ§å›¾å½¢é¡µé¢
    participant Log as Logger

    Note over OBS,Graphics: æ¨æµå¼€å§‹åæŒç»­ç›‘æ§

    loop æ¯ 1 ç§’
        OBS->>Ext: StreamStatus äº‹ä»¶<br/>(bitrate, droppedFrames, audioLevel)
        activate Ext
        Ext->>Ext: è§£ææ¨æµæ•°æ®
        Ext->>Rep: æ›´æ–° streamStats Replicant<br/>timestamp = now()
        activate Rep

        Rep-->>Dashboard: åŒæ­¥åˆ° Dashboard
        Rep-->>Graphics: åŒæ­¥åˆ°ç›‘æ§å›¾å½¢é¡µé¢

        Dashboard->>Dashboard: æ›´æ–°ç ç‡æ˜¾ç¤º (Kbps)
        Dashboard->>Dashboard: æ›´æ–°ä¸¢åŒ…ç‡ç™¾åˆ†æ¯”
        Dashboard->>Dashboard: æ›´æ–°éŸ³é‡ç”µå¹³è¡¨

        Graphics->>Graphics: æ¸²æŸ“éŸ³é‡ç”µå¹³åŠ¨ç”»
        Graphics->>Graphics: æ¸²æŸ“ç ç‡æ›²çº¿å›¾
        deactivate Rep

        alt ç ç‡ä½äºé˜ˆå€¼
            Ext->>Log: è®°å½•è­¦å‘Šæ—¥å¿—<br/>event: "low_bitrate_warning"
            Ext->>Dashboard: è§¦å‘çº¢è‰²è­¦å‘Šæç¤º
        else ä¸¢åŒ…ç‡é«˜äºé˜ˆå€¼
            Ext->>Log: è®°å½•è­¦å‘Šæ—¥å¿—<br/>event: "high_dropped_frames_warning"
            Ext->>Dashboard: è§¦å‘çº¢è‰²è­¦å‘Šæç¤º
        else éŸ³é‡ç”µå¹³è¿‡é«˜
            Ext->>Log: è®°å½•è­¦å‘Šæ—¥å¿—<br/>event: "audio_clipping_warning"
            Ext->>Dashboard: è§¦å‘é»„è‰²è­¦å‘Šæç¤º
        else æ­£å¸¸
            Ext->>Log: è®°å½•æ­£å¸¸çŠ¶æ€<br/>event: "stream_stats_normal"
        end

        deactivate Ext
    end
```

---

## æ•°æ®åŒæ­¥æµç¨‹

### å¯åŠ¨æ—¶æ‹‰å–é…ç½®

```mermaid
sequenceDiagram
    participant NC as NodeCG æ ¸å¿ƒ
    participant SYNC as Data Sync Service
    participant Cache as æœ¬åœ°ç¼“å­˜ (db/)
    participant API as Google Sheets API
    participant GS as Google Sheets
    participant Bundles as å„ Bundle æ¨¡å—

    NC->>SYNC: ç³»ç»Ÿå¯åŠ¨ï¼Œåˆå§‹åŒ–æ•°æ®åŒæ­¥æœåŠ¡
    activate SYNC

    SYNC->>Cache: æ£€æŸ¥æœ¬åœ°ç¼“å­˜
    Cache-->>SYNC: è¿”å›ç¼“å­˜çŠ¶æ€ (æœ‰/æ— /è¿‡æœŸ)

    alt æœ¬åœ°ç¼“å­˜æœ‰æ•ˆ
        SYNC->>SYNC: ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®
        SYNC->>Bundles: åˆ†å‘é…ç½®åˆ°å„æ¨¡å—
    else æœ¬åœ°ç¼“å­˜æ— æ•ˆæˆ–è¿‡æœŸ
        SYNC->>API: è°ƒç”¨ Sheets API<br/>è¯»å–è¡¨1å’Œè¡¨2
        activate API
        API->>GS: GET /values/è¡¨1!A1:Z1000
        activate GS
        GS-->>API: è¿”å›è¡¨1æ•°æ® (JSON)
        deactivate GS
        API->>GS: GET /values/è¡¨2!A1:Z1000
        activate GS
        GS-->>API: è¿”å›è¡¨2æ•°æ® (JSON)
        deactivate GS
        API-->>SYNC: è¿”å›å®Œæ•´é…ç½®æ•°æ®
        deactivate API

        SYNC->>SYNC: è§£æå’ŒéªŒè¯æ•°æ®
        SYNC->>Cache: å†™å…¥æœ¬åœ°ç¼“å­˜<br/>timestamp = now()
        SYNC->>Bundles: åˆ†å‘é…ç½®åˆ°å„æ¨¡å—
    end

    Bundles-->>SYNC: ç¡®è®¤æ¥æ”¶é…ç½®
    SYNC->>NC: æ•°æ®åŒæ­¥å®Œæˆ
    deactivate SYNC
```

### ä¸Šè¡ŒåŒæ­¥åˆ°äº‘ç«¯

```mermaid
flowchart TD
    Start([ç”¨æˆ·è§¦å‘ä¸Šè¡ŒåŒæ­¥]) --> ValidateData[éªŒè¯æœ¬åœ°æ•°æ®å®Œæ•´æ€§]
    ValidateData --> CheckValid{æ•°æ®æ˜¯å¦æœ‰æ•ˆ?}

    CheckValid -->|å¦| ShowError[æ˜¾ç¤ºé”™è¯¯æç¤º<br/>åŒæ­¥å¤±è´¥]
    ShowError --> End([ç»“æŸ])

    CheckValid -->|æ˜¯| ReadReplicant[è¯»å–å½“å‰ Replicant æ•°æ®<br/>(ä¾‹: MixerState)]
    ReadReplicant --> FormatData[æ ¼å¼åŒ–ä¸º Sheets æ•°æ®æ ¼å¼<br/>(äºŒç»´æ•°ç»„)]

    FormatData --> CallAPI[è°ƒç”¨ Google Sheets API<br/>batchUpdate]
    CallAPI --> APIRequest{API è¯·æ±‚}

    APIRequest -->|ç½‘ç»œé”™è¯¯| RetryCheck{é‡è¯•æ¬¡æ•° < 3?}
    RetryCheck -->|æ˜¯| Wait[ç­‰å¾… 3 ç§’]
    Wait --> CallAPI
    RetryCheck -->|å¦| SyncFailed[åŒæ­¥å¤±è´¥]
    SyncFailed --> LogError[è®°å½•é”™è¯¯æ—¥å¿—<br/>event: "cloud_sync_failed"]
    LogError --> ShowError

    APIRequest -->|æˆåŠŸ| UpdateSheet[æ›´æ–° Google Sheets]
    UpdateSheet --> WriteTimestamp[å†™å…¥åŒæ­¥æ—¶é—´æˆ³åˆ°è¡¨æ ¼]
    WriteTimestamp --> UpdateCache[æ›´æ–°æœ¬åœ°ç¼“å­˜<br/>timestamp = now()]

    UpdateCache --> LogSuccess[è®°å½•æˆåŠŸæ—¥å¿—<br/>event: "cloud_sync_success"<br/>timestamp: now()]
    LogSuccess --> ShowSuccess[æ˜¾ç¤ºæˆåŠŸæç¤º<br/>"åŒæ­¥å®Œæˆ"]
    ShowSuccess --> End
```

---

## æ—¥å¿—ç³»ç»Ÿæµç¨‹

### æ—¥å¿—è®°å½•ä¸æŸ¥è¯¢

```mermaid
flowchart TD
    Start([äº‹ä»¶å‘ç”Ÿ]) --> EmitEvent[æ¨¡å—è§¦å‘æ—¥å¿—äº‹ä»¶<br/>logger.log(...)]
    EmitEvent --> CreateEntry[åˆ›å»º LogEntry å¯¹è±¡<br/>timestamp = now()]

    CreateEntry --> PushQueue[æ¨å…¥å¼‚æ­¥å†™å…¥é˜Ÿåˆ—]
    PushQueue --> UpdateMemory[æ›´æ–°å†…å­˜ä¸­çš„ Replicant<br/>(ç”¨äºå®æ—¶æŸ¥è¯¢)]

    UpdateMemory --> QueueProcess{é˜Ÿåˆ—å¤„ç†}
    QueueProcess --> BatchWrite[æ‰¹é‡å†™å…¥æ—¥å¿—æ–‡ä»¶<br/>(æ¯ 100 æ¡æˆ–æ¯ 5 ç§’)]

    BatchWrite --> FormatLog[æ ¼å¼åŒ–ä¸º JSON Lines]
    FormatLog --> WriteFile[å¼‚æ­¥å†™å…¥åˆ°<br/>logs/YYYY-MM-DD.log]
    WriteFile --> WriteDone[å†™å…¥å®Œæˆ]

    WriteDone --> CheckSize{æ—¥å¿—æ–‡ä»¶å¤§å° > 100MB?}
    CheckSize -->|æ˜¯| RotateLog[è½®è½¬æ—¥å¿—æ–‡ä»¶<br/>é‡å‘½åä¸º .log.1]
    CheckSize -->|å¦| WaitNext[ç­‰å¾…ä¸‹æ¬¡å†™å…¥]
    RotateLog --> WaitNext

    subgraph Query["æ—¥å¿—æŸ¥è¯¢æµç¨‹"]
        UserQuery([ç”¨æˆ·æŸ¥è¯¢æ—¥å¿—]) --> QueryType{æŸ¥è¯¢ç±»å‹}
        QueryType -->|å®æ—¶æŸ¥è¯¢| QueryMemory[ä» Replicant æŸ¥è¯¢<br/>(æœ€è¿‘ 1000 æ¡)]
        QueryType -->|å†å²æŸ¥è¯¢| QueryFile[ä»æ—¥å¿—æ–‡ä»¶æŸ¥è¯¢]

        QueryMemory --> FilterMemory{åº”ç”¨è¿‡æ»¤æ¡ä»¶<br/>(æ—¶é—´/äº‹ä»¶/æ¨¡å—)}
        QueryFile --> ReadFile[è¯»å–å¯¹åº”æ—¥æœŸæ–‡ä»¶]
        ReadFile --> FilterFile{åº”ç”¨è¿‡æ»¤æ¡ä»¶}

        FilterMemory --> ReturnResult[è¿”å›æŸ¥è¯¢ç»“æœ]
        FilterFile --> ReturnResult
        ReturnResult --> DisplayDashboard[åœ¨ Dashboard æ˜¾ç¤º]
    end
```

### å®šæœŸæ¸…ç†è¿‡æœŸæ—¥å¿—

```mermaid
sequenceDiagram
    participant Cron as å®šæ—¶ä»»åŠ¡ (node-cron)
    participant Cleaner as Log Cleaner
    participant FS as æ–‡ä»¶ç³»ç»Ÿ (fs)
    participant Log as Logger

    Note over Cron: æ¯å¤©å‡Œæ™¨ 2:00 æ‰§è¡Œ

    Cron->>Cleaner: è§¦å‘æ¸…ç†ä»»åŠ¡
    activate Cleaner

    Cleaner->>FS: è¯»å– logs/ ç›®å½•
    activate FS
    FS-->>Cleaner: è¿”å›æ‰€æœ‰æ—¥å¿—æ–‡ä»¶åˆ—è¡¨
    deactivate FS

    loop éå†æ¯ä¸ªæ—¥å¿—æ–‡ä»¶
        Cleaner->>Cleaner: è§£ææ–‡ä»¶åè·å–æ—¥æœŸ
        Cleaner->>Cleaner: è®¡ç®—æ–‡ä»¶å¹´é¾„ (å¤©æ•°)

        alt æ–‡ä»¶å¹´é¾„ > ä¿ç•™æœŸé™ (ä¾‹: 30 å¤©)
            Cleaner->>FS: åˆ é™¤æ–‡ä»¶
            activate FS
            FS-->>Cleaner: åˆ é™¤æˆåŠŸ
            deactivate FS
            Cleaner->>Log: è®°å½•åˆ é™¤æ—¥å¿—<br/>event: "log_file_deleted"<br/>timestamp: now()
        else æ–‡ä»¶å¹´é¾„ <= ä¿ç•™æœŸé™
            Cleaner->>Cleaner: è·³è¿‡è¯¥æ–‡ä»¶
        end
    end

    Cleaner->>Log: è®°å½•æ¸…ç†å®Œæˆæ—¥å¿—<br/>event: "log_cleanup_completed"<br/>deleted_count: N
    Cleaner->>Cron: ä»»åŠ¡å®Œæˆ
    deactivate Cleaner
```

---

## å¤‡ä»½æ¢å¤æµç¨‹

### è‡ªåŠ¨å®šæ—¶å¤‡ä»½

```mermaid
flowchart TD
    Start([å®šæ—¶è§¦å‘<br/>ä¾‹: æ¯å¤© 03:00]) --> CheckMode{å¤‡ä»½æ¨¡å¼}

    CheckMode -->|è‡ªåŠ¨å¤‡ä»½å·²å¯ç”¨| StartBackup[å¼€å§‹å¤‡ä»½æµç¨‹]
    CheckMode -->|è‡ªåŠ¨å¤‡ä»½å·²ç¦ç”¨| Skip([è·³è¿‡å¤‡ä»½])

    StartBackup --> CreateTimestamp[ç”Ÿæˆæ—¶é—´æˆ³<br/>YYYYMMDD_HHmmss]
    CreateTimestamp --> CollectReplicants[æ”¶é›†æ‰€æœ‰ Replicants æ•°æ®]

    CollectReplicants --> SerializeData[åºåˆ—åŒ–ä¸º JSON]
    SerializeData --> CollectConfig[æ”¶é›†é…ç½®æ–‡ä»¶<br/>cfg/*.json]

    CollectConfig --> CreateArchive[åˆ›å»ºå‹ç¼©åŒ…]
    CreateArchive --> CompressData[ä½¿ç”¨ zlib å‹ç¼©]

    CompressData --> SaveFile[ä¿å­˜ä¸º<br/>backups/backup_YYYYMMDD_HHmmss.zip]
    SaveFile --> VerifyBackup{éªŒè¯å¤‡ä»½å®Œæ•´æ€§}

    VerifyBackup -->|å¤±è´¥| LogError[è®°å½•é”™è¯¯æ—¥å¿—<br/>event: "backup_failed"]
    VerifyBackup -->|æˆåŠŸ| LogSuccess[è®°å½•æˆåŠŸæ—¥å¿—<br/>event: "backup_created"<br/>timestamp: now()]

    LogSuccess --> CheckOldBackups[æ£€æŸ¥æ—§å¤‡ä»½æ–‡ä»¶]
    CheckOldBackups --> FilterOld{è¿‡æ»¤è¿‡æœŸå¤‡ä»½<br/>(ä¾‹: > 7 å¤©)}

    FilterOld -->|æœ‰è¿‡æœŸæ–‡ä»¶| DeleteOld[åˆ é™¤è¿‡æœŸå¤‡ä»½]
    FilterOld -->|æ— è¿‡æœŸæ–‡ä»¶| Done([å¤‡ä»½å®Œæˆ])

    DeleteOld --> LogDelete[è®°å½•åˆ é™¤æ—¥å¿—<br/>event: "old_backup_deleted"]
    LogDelete --> Done
    LogError --> Done
```

### æ‰‹åŠ¨æ¢å¤æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ· Dashboard
    participant Ext as Backup Extension
    participant FS as æ–‡ä»¶ç³»ç»Ÿ
    participant NC as NodeCG æ ¸å¿ƒ
    participant Bundles as å„ Bundle æ¨¡å—
    participant Log as Logger

    User->>Ext: æ‰“å¼€å¤‡ä»½æ¢å¤é¢æ¿
    activate Ext
    Ext->>FS: è¯»å– backups/ ç›®å½•
    activate FS
    FS-->>Ext: è¿”å›å¤‡ä»½æ–‡ä»¶åˆ—è¡¨
    deactivate FS
    Ext->>Ext: æŒ‰æ—¶é—´æˆ³æ’åº
    Ext-->>User: æ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶åˆ—è¡¨<br/>(æ–‡ä»¶åã€å¤§å°ã€æ—¥æœŸ)
    deactivate Ext

    User->>Ext: é€‰æ‹©å¤‡ä»½æ–‡ä»¶ + ç‚¹å‡»æ¢å¤
    activate Ext
    Ext->>User: æ˜¾ç¤ºç¡®è®¤å¼¹çª—<br/>"ç¡®å®šè¦æ¢å¤å—? å½“å‰æ•°æ®å°†è¢«è¦†ç›–"
    deactivate Ext

    User->>Ext: ç‚¹å‡» "ç¡®è®¤"
    activate Ext

    Ext->>Log: è®°å½•æ—¥å¿—<br/>event: "restore_started"<br/>backup_file: xxx.zip

    Ext->>FS: è¯»å–å¤‡ä»½æ–‡ä»¶
    activate FS
    FS-->>Ext: è¿”å›å‹ç¼©æ–‡ä»¶å†…å®¹
    deactivate FS

    Ext->>Ext: è§£å‹ç¼©æ•°æ®
    Ext->>Ext: éªŒè¯æ•°æ®å®Œæ•´æ€§ (JSON schema)

    alt æ•°æ®éªŒè¯å¤±è´¥
        Ext->>Log: è®°å½•é”™è¯¯æ—¥å¿—<br/>event: "restore_failed"<br/>reason: "invalid_data"
        Ext->>User: æ˜¾ç¤ºé”™è¯¯æç¤º<br/>"å¤‡ä»½æ–‡ä»¶æŸå"
    else æ•°æ®éªŒè¯æˆåŠŸ
        Ext->>NC: è¯·æ±‚æš‚åœæ‰€æœ‰ Bundles
        activate NC
        NC->>Bundles: å‘é€ pause ä¿¡å·
        Bundles-->>NC: ç¡®è®¤å·²æš‚åœ
        NC-->>Ext: Bundles å·²æš‚åœ
        deactivate NC

        Ext->>Ext: æ¢å¤ Replicants æ•°æ®
        Ext->>FS: æ¢å¤é…ç½®æ–‡ä»¶åˆ° cfg/
        activate FS
        FS-->>Ext: å†™å…¥æˆåŠŸ
        deactivate FS

        Ext->>NC: è¯·æ±‚é‡è½½é…ç½®
        activate NC
        NC->>Bundles: é‡è½½é…ç½® + é‡å¯ Bundles
        Bundles-->>NC: é‡å¯å®Œæˆ
        NC-->>Ext: é‡è½½å®Œæˆ
        deactivate NC

        Ext->>Log: è®°å½•æˆåŠŸæ—¥å¿—<br/>event: "restore_completed"<br/>timestamp: now()
        Ext->>User: æ˜¾ç¤ºæˆåŠŸæç¤º<br/>"æ¢å¤å®Œæˆï¼Œç³»ç»Ÿå·²é‡è½½"
    end

    deactivate Ext
```

---

## ğŸ“ æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº† LeafSeamer ç³»ç»Ÿçš„æ ¸å¿ƒæµç¨‹å›¾ï¼Œæ¶µç›–ï¼š

- âœ… **ç³»ç»Ÿå¯åŠ¨**: NodeCG æ ¸å¿ƒåˆå§‹åŒ–ã€Bundle åŠ è½½ã€å¤–éƒ¨è®¾å¤‡è¿æ¥
- âœ… **Mixer Control**: OSC è¿æ¥ã€çŠ¶æ€ç›‘å¬ã€ç”¨æˆ·æ“ä½œã€äº‘ç«¯åŒæ­¥
- âœ… **OBS Control**: WebSocket è¿æ¥ã€åœºæ™¯ç®¡ç†ã€è§†é¢‘é˜Ÿåˆ—ã€æ¨æµç›‘æ§
- âœ… **æ•°æ®åŒæ­¥**: äº‘ç«¯æ‹‰å–é…ç½®ã€æœ¬åœ°ç¼“å­˜ã€ä¸Šè¡ŒåŒæ­¥
- âœ… **æ—¥å¿—ç³»ç»Ÿ**: å¼‚æ­¥å†™å…¥ã€å®æ—¶æŸ¥è¯¢ã€å®šæœŸæ¸…ç†
- âœ… **å¤‡ä»½æ¢å¤**: è‡ªåŠ¨å®šæ—¶å¤‡ä»½ã€æ‰‹åŠ¨æ¢å¤ã€æ•°æ®éªŒè¯

---

> æœ¬æ–‡æ¡£å°†éšé¡¹ç›®æ¼”è¿›å®æ—¶æ›´æ–°ï¼Œä¿æŒä¸å®é™…ä»£ç åŒæ­¥ã€‚
