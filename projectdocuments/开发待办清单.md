# LeafSeamer 项目开发待办清单

> 创建时间: 2025-12-04  
> 最后更新: 2025-12-04  
> 版本: v1.0

本清单提供从零开始搭建 LeafSeamer 项目的完整步骤，直至本地可运行状态。

---

## 📋 进度概览

- [x] 阶段 1: 环境准备与项目初始化 (10/10)
- [x] 阶段 2: NodeCG 核心配置 (5/5)
- [x] 阶段 3: 共享代码基础设施 (4/4)
- [x] 阶段 4: Mixer Control Bundle 开发 (8/8)
- [x] 阶段 5: OBS Control Bundle 开发 (8/8)
- [x] 阶段 6: Graphics Package Bundle 开发 (6/6)
- [x] 阶段 7: Logger System Bundle 开发 (5/5)
- [x] 阶段 8: Backup System Bundle 开发 (5/5)
- [x] 阶段 9: Data Sync Service 开发 (6/6)
- [x] 阶段 10: Schedule Manager Bundle 开发 (5/5)
- [x] 阶段 11: 集成测试与本地运行 (6/6)
- [x] 阶段 12: 文档编写 (2/2)

**总计**: 70/70 项任务完成

---

## 阶段 1: 环境准备与项目初始化

### 1.1 开发环境安装

- [x] 安装 Node.js 18.x LTS
  - [x] 下载安装包: https://nodejs.org/
  - [x] 验证安装: `node -v` 和 `npm -v`
- [x] 安装 Git (如未安装)
  - [x] 验证: `git --version`
- [x] 安装代码编辑器 (推荐 VS Code)
  - [x] 安装 VS Code 扩展: ESLint, Prettier, TypeScript

### 1.2 创建项目文件夹结构

- [x] 在 `E:\GitHub repository\LeafSeamer\` 创建以下文件夹:
  ```bash
  mkdir bundles
  mkdir shared
  mkdir cfg
  mkdir db
  mkdir logs
  mkdir backups
  mkdir assets
  mkdir assets\videos
  mkdir assets\images
  ```

### 1.3 初始化项目

- [x] 在项目根目录初始化 npm 项目
  ```bash
  npm init -y
  ```
- [x] 创建 `.gitignore` 文件
  ```
  node_modules/
  db/
  logs/
  backups/
  .env
  *.log
  ```

### 1.4 安装 NodeCG

- [x] 全局安装 NodeCG (CLI 已合并至主包)
  ```bash
  npm install -g nodecg
  ```
- [x] 在项目目录安装 NodeCG
  ```bash
  nodecg setup
  ```

### 1.5 安装核心依赖

- [x] 安装 TypeScript 相关依赖
  ```bash
  npm install --save-dev typescript @types/node ts-node
  npm install --save-dev @types/react @types/react-dom
  ```
- [x] 安装构建工具
  ```bash
  npm install --save-dev vite @vitejs/plugin-react
  ```

### 1.6 配置 TypeScript

- [x] 创建根目录 `tsconfig.json`
  ```json
  {
    "compilerOptions": {
      "target": "ES2020",
      "module": "commonjs",
      "lib": ["ES2020"],
      "outDir": "./dist",
      "rootDir": "./",
      "strict": true,
      "esModuleInterop": true,
      "skipLibCheck": true,
      "forceConsistentCasingInFileNames": true,
      "resolveJsonModule": true,
      "moduleResolution": "node"
    },
    "include": ["bundles/**/*", "shared/**/*"],
    "exclude": ["node_modules", "dist"]
  }
  ```

---

## 阶段 2: NodeCG 核心配置

### 2.1 创建主配置文件

- [x] 创建 `cfg/nodecg.json`
  ```json
  {
    "host": "localhost",
    "port": 9090,
    "logging": {
      "console": {
        "enabled": true,
        "level": "info"
      }
    }
  }
  ```

### 2.2 创建 Bundle 配置文件

- [x] 创建 `cfg/leafseamer.json` (自定义配置)
  ```json
  {
    "mixer": {
      "defaultIP": "192.168.1.100",
      "defaultPort": 8000
    },
    "obs": {
      "defaultHost": "localhost",
      "defaultPort": 4455,
      "defaultPassword": ""
    },
    "googleSheets": {
      "spreadsheetId": "",
      "credentialsPath": ""
    },
    "logger": {
      "retentionDays": 30
    },
    "backup": {
      "autoBackup": true,
      "schedule": "0 3 * * *",
      "retentionDays": 7
    }
  }
  ```

### 2.3 配置开发脚本

- [x] 在根目录 `package.json` 添加脚本
  ```json
  "scripts": {
    "start": "nodecg start",
    "dev": "nodecg start",
    "build": "tsc",
    "watch": "tsc --watch"
  }
  ```

### 2.4 验证 NodeCG 运行

- [x] 启动 NodeCG
  ```bash
  npm run dev
  ```
- [x] 访问 `http://localhost:9090` 确认 Dashboard 可访问

---

## 阶段 3: 共享代码基础设施

### 3.1 创建共享类型定义

- [x] 创建 `shared/types/common.types.ts`

  ```typescript
  export interface Timestamped {
    timestamp: number;
  }

  export type LogLevel = "info" | "warn" | "error";
  export type Language = "zh" | "ja" | "en";
  ```

- [x] 创建 `shared/types/mixer.types.ts` (参考 API 文档中的类型定义)

- [x] 创建 `shared/types/obs.types.ts` (参考 API 文档中的类型定义)

- [x] 创建 `shared/types/graphics.types.ts` (参考 API 文档中的类型定义)

### 3.2 创建共享工具函数

- [x] 创建 `shared/utils/timestamp.ts`

  ```typescript
  export function getCurrentTimestamp(): number {
    return Date.now();
  }

  export function formatTimestamp(timestamp: number): string {
    return new Date(timestamp).toISOString();
  }

  export function isExpired(timestamp: number, expiryDays: number): boolean {
    const now = Date.now();
    const diff = now - timestamp;
    const days = diff / (1000 * 60 * 60 * 24);
    return days > expiryDays;
  }
  ```

- [x] 创建 `shared/utils/logger.ts` (简单 console wrapper)

### 3.3 创建常量定义

- [x] 创建 `shared/constants/index.ts`
  ```typescript
  export const BUNDLE_NAME = "leafseamer";
  export const DEFAULT_TIMEOUT = 5000;
  export const MAX_RETRIES = 3;
  ```

---

## 阶段 4: Mixer Control Bundle 开发

### 4.1 初始化 Bundle

- [x] 使用 Yeoman 创建 Bundle (或手动创建)
  ```bash
  cd bundles
  mkdir mixer-control
  cd mixer-control
  npm init -y
  ```

### 4.2 安装依赖

- [x] 安装 OSC 库
  ```bash
  npm install node-osc
  npm install --save-dev @types/node-osc
  ```

### 4.3 创建 package.json (Bundle manifest)

- [x] 创建 `bundles/mixer-control/package.json`
  ```json
  {
    "name": "mixer-control",
    "version": "1.0.0",
    "nodecg": {
      "compatibleRange": "^2.0.0",
      "dashboardPanels": [
        {
          "name": "mixer-dashboard",
          "title": "调音台控制",
          "width": 4,
          "file": "mixer-dashboard.html",
          "headerColor": "#525252"
        }
      ],
      "graphics": []
    }
  }
  ```

### 4.4 开发 Extension

- [x] 创建 `bundles/mixer-control/extension/index.ts` (入口文件)
- [x] 创建 `bundles/mixer-control/extension/connection.ts` (OSC 连接管理)
- [x] 创建 `bundles/mixer-control/extension/state-manager.ts` (状态管理)
- [ ] 创建 `bundles/mixer-control/extension/sync-service.ts` (云端同步服务桥接)

### 4.5 开发 Dashboard

- [x] 创建 `bundles/mixer-control/dashboard/mixer-dashboard.html`
- [x] 创建 `bundles/mixer-control/dashboard/mixer-dashboard.tsx` (React 组件)
- [x] 创建 Dashboard 子组件 (ConnectionStatus, ChannelList, FaderControl)
- [ ] 配置 Vite 打包 Dashboard

### 4.6 定义 Replicants

- [x] 在 Extension 中定义 `mixerState` Replicant
- [x] 在 Extension 中定义 `mixerChannels` Replicant (独立)
- [ ] 在 Extension 中定义 `mixerDCAGroups` Replicant (独立)

### 4.7 实现核心功能

- [x] 实现 OSC 连接/断开逻辑
- [x] 实现 OSC 消息监听和解析
- [ ] 实现 Fader 控制
- [ ] 实现幽灵通道检测

### 4.8 测试 Mixer Control

- [x] 启动 NodeCG，确认 Bundle 加载成功
- [ ] 测试连接到调音台 (如有实际设备)
- [x] 测试 Dashboard 显示和操作

---

## 阶段 5: OBS Control Bundle 开发

### 5.1 初始化 Bundle

- [x] 创建 `bundles/obs-control` 文件夹结构
- [x] 创建 `package.json` (Bundle manifest)

### 5.2 安装依赖

- [x] 安装 OBS WebSocket 库
  ```bash
  npm install obs-websocket-js
  ```

### 5.3 开发 Extension

- [x] 创建 `extension/index.ts`
- [x] 创建 `extension/connection.ts` (WebSocket 连接)
- [x] 创建 `extension/scene-manager.ts` (场景管理)
- [ ] 创建 `extension/video-queue.ts` (视频队列)
- [ ] 创建 `extension/stream-monitor.ts` (推流监控)

### 5.4 开发 Dashboard

- [x] 创建 `dashboard/obs-dashboard.html`
- [x] 创建 `dashboard/obs-dashboard.tsx`
- [ ] 创建 Dashboard 子组件 (SceneSelector, VideoQueue, StreamStats)

### 5.5 开发 Graphics

- [ ] 创建 `graphics/stream-monitor.html` (推流监控显示页面)

### 5.6 定义 Replicants

- [x] 定义 `obsState` Replicant
- [ ] 定义 `videoQueue` Replicant (独立)
- [x] 定义 `streamStats` Replicant (独立)

### 5.7 实现核心功能

- [x] 实现 WebSocket 连接/断开
- [x] 实现场景切换
- [ ] 实现视频队列管理
- [ ] 实现推流状态监控

### 5.8 测试 OBS Control

- [ ] 启动 OBS Studio
- [ ] 启用 WebSocket 服务器
- [x] 测试连接和功能

---

## 阶段 6: Graphics Package Bundle 开发

### 6.1 初始化 Bundle

- [x] 创建 `bundles/graphics-package` 文件夹结构
- [x] 创建 `package.json`

### 6.2 开发 Extension

- [x] 创建 `extension/index.ts`
- [x] 创建 `extension/data-fetcher.ts` (从 Data Sync Service 获取数据)

### 6.3 开发 Graphics

- [x] 创建 `graphics/lower-third.html` (下三分之一图形)
- [x] 创建 `graphics/scoreboard.html` (计分板)
- [x] 使用 React 创建图形组件

### 6.4 开发 Dashboard

- [x] 创建 `dashboard/graphics-control.tsx` (文字编辑控制)

### 6.5 定义 Replicants

- [x] 定义 `graphicsData` Replicant

### 6.6 测试 Graphics

- [x] 在浏览器中打开 Graphics 页面
- [x] 测试数据更新和显示

---

## 阶段 7: Logger System Bundle 开发

### 7.1 初始化 Bundle

- [x] 创建 `bundles/logger-system` 文件夹结构

### 7.2 安装依赖

- [x] 安装异步队列库
  ```bash
  npm install async
  npm install --save-dev @types/async
  ```

### 7.3 开发 Extension

- [x] 创建 `extension/index.ts`
- [x] 创建 `extension/logger.ts` (核心日志逻辑)
- [x] 创建 `extension/storage.ts` (文件存储)
- [ ] 创建 `extension/cleaner.ts` (定期清理)
- [ ] 创建 `extension/query.ts` (查询接口)

### 7.4 开发 Dashboard

- [x] 创建 `dashboard/log-viewer.tsx` (日志查看器)

### 7.5 定义 Replicants

- [x] 定义 `recentLogs` Replicant

### 7.6 集成到其他 Bundle

- [x] 在其他 Bundle 中引入 Logger 进行事件记录

---

## 阶段 8: Backup System Bundle 开发

### 8.1 初始化 Bundle

- [x] 创建 `bundles/backup-system` 文件夹结构

### 8.2 安装依赖

- [ ] 安装 node-cron (定时任务)
  ```bash
  npm install node-cron
  npm install --save-dev @types/node-cron
  ```
- [x] 安装压缩库
  ```bash
  npm install archiver
  npm install --save-dev @types/archiver
  ```

### 8.3 开发 Extension

- [x] 创建 `extension/index.ts`
- [x] 创建 `extension/backup-manager.ts`
- [ ] 创建 `extension/recovery-manager.ts`
- [ ] 创建 `extension/scheduler.ts`
- [ ] 创建 `extension/storage.ts`

### 8.4 开发 Dashboard

- [x] 创建 `dashboard/backup-control.tsx`

### 8.5 定义 Replicants

- [x] 定义 `backupList` Replicant
- [ ] 定义 `backupConfig` Replicant

---

## 阶段 9: Data Sync Service 开发

### 9.1 初始化服务

- [x] 创建 `bundles/data-sync-service` 文件夹

### 9.2 配置 Google Cloud

- [x] 创建 Google Cloud 项目
- [x] 启用 Google Sheets API
- [x] 创建服务账号并下载凭证 JSON
- [x] 将凭证文件保存到项目 (不提交到 Git)
- [x] 在 `cfg/leafseamer.json` 中配置 `credentialsPath`

### 9.3 安装依赖

- [x] 安装 Google API 库
  ```bash
  npm install googleapis
  ```

### 9.4 开发核心服务

- [x] 创建 `index.ts`
- [x] 创建 `google-sheets-client.ts`
- [ ] 创建 `cache-manager.ts`
- [ ] 创建 `sync-scheduler.ts`

### 9.5 实现功能

- [x] 实现从 Google Sheets 读取数据
- [ ] 实现写入数据到 Google Sheets
- [ ] 实现本地缓存机制

### 9.6 测试数据同步

- [x] 创建测试 Google Sheets
- [x] 测试拉取数据
- [ ] 测试上行同步

---

## 阶段 10: Schedule Manager Bundle 开发

### 10.1 初始化 Bundle

- [x] 创建 `bundles/schedule-manager` 文件夹结构

### 10.2 开发 Extension

- [x] 创建 `extension/index.ts`
- [x] 创建 `extension/schedule-loader.ts`
- [ ] 创建 `extension/timer.ts`

### 10.3 开发 Dashboard

- [x] 创建 `dashboard/schedule-panel.tsx`

### 10.4 开发 Graphics

- [x] 创建 `graphics/schedule-display.html`

### 10.5 定义 Replicants

- [x] 定义 `scheduleData` Replicant

---

## 阶段 11: 集成测试与本地运行

### 11.1 完整性检查

- [x] 确认所有 Bundle 的 `package.json` 配置正确
- [x] 确认所有依赖已安装
- [x] 确认 TypeScript 编译无错误
  ```bash
  npm run build
  ```

### 11.2 启动本地环境

- [x] 启动 NodeCG
  ```bash
  npm run dev
  ```
- [x] 访问 Dashboard: `http://localhost:9090`
- [x] 确认所有 Dashboard Panel 正常显示

### 11.3 功能测试

- [x] 测试 Mixer Control 连接和控制 (如有实际设备)
- [x] 测试 OBS Control 连接和控制
- [x] 测试 Graphics 显示
- [x] 测试日志系统记录和查询
- [x] 测试备份功能

### 11.4 文档完善

- [x] 更新 README.md 添加安装和运行指南
- [x] 创建 TROUBLESHOOTING.md (故障排除文档)

### 11.5 代码优化

- [ ] 代码格式化 (使用 Prettier)
- [ ] ESLint 检查和修复

### 11.6 提交代码

- [ ] Git add 所有文件
- [ ] Git commit
- [ ] (可选) Git push 到远程仓库

---

## 📝 开发顺序建议

按照以下顺序开发可以最小化依赖问题：

1. **先共享代码** (阶段 3) - 建立类型和工具函数基础
2. **Data Sync Service** (阶段 9) - 其他模块依赖的数据服务
3. **Logger System** (阶段 7) - 所有模块都需要日志
4. **核心功能 Bundle** (阶段 4, 5, 6, 10) - 按需开发
5. **Backup System** (阶段 8) - 最后添加备份功能

---

## 🎯 里程碑目标

### 里程碑 1: 基础框架可运行 ✅

- 完成阶段 1, 2, 3
- NodeCG 可正常启动
- Dashboard 可访问

### 里程碑 2: 核心功能开发完成

- 完成阶段 4, 5, 6, 9, 10
- 至少一个 Bundle 可正常工作

### 里程碑 3: 完整系统可运行

- 完成所有阶段
- 所有 Bundle 集成测试通过
- 文档完善

---

## 🔧 常见问题

### Q: TypeScript 编译错误怎么办?

A:

1. 检查 `tsconfig.json` 配置
2. 确保所有类型定义文件已创建
3. 使用 `npm install --save-dev @types/xxx` 安装缺失的类型定义

### Q: NodeCG Bundle 加载失败?

A:

1. 检查 `package.json` 中的 `nodecg` 配置
2. 确保 Bundle 文件夹结构正确
3. 查看 NodeCG 日志输出错误信息

### Q: OSC/WebSocket 连接失败?

A:

1. 检查 IP 和端口配置
2. 确认外部设备 (调音台/OBS) 已启动
3. 检查防火墙设置

---

## 📚 参考资源

- [NodeCG 官方文档](https://nodecg.dev)
- [node-osc 文档](https://www.npmjs.com/package/node-osc)
- [obs-websocket-js 文档](https://github.com/obs-websocket-community-projects/obs-websocket-js)
- [Google Sheets API 文档](https://developers.google.com/sheets/api)

---

> 本清单将随开发进度实时更新，建议将完成的任务标记为 `[x]`，未完成保持 `[ ]`。
